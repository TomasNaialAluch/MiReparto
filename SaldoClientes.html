<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Saldo Clientes - Mi Reparto</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* ... tus estilos existentes ... */

    /* Reglas de impresión */
    @media print {
      @page { size: A4 portrait; margin: 0; }
      body, html { margin: 0; padding: 0; }
      .container { margin: 0 auto !important; padding: 0 !important; }
      .no-print { display: none !important; }
      body * { visibility: hidden; }
      .printable, .printable * { visibility: visible; }
      .printable {
        position: absolute; top: 0; left: 50%; transform: translateX(-50%);
        width: 100%; max-width: 600px; padding: 0.5rem;
      }
      .print-header { font-size: 24pt; text-align: center; margin-bottom: 1rem; }
      .print-small { font-size: 10pt; margin: 0; }
      .print-message { font-size: 18pt !important; text-align: center; }
      .print-subtotal { font-size: 14pt; margin-top: 1rem; }
    }
  </style>
</head>
<body>
  <!-- ... tu navbar y formulario sin cambios ... -->

  <div class="container mt-4">
    <!-- Formulario intacto -->
    <div class="card no-print">
      <!-- ... todo tu formulario ... -->
    </div>

    <!-- Resumen e Impresión -->
    <div id="summarySection" class="card p-4 printable" style="display: none;">
      <div id="summaryContent"></div>
      <div id="subtotalSection" class="subtotal-container no-print"></div>
      <div id="finalBalanceSection" class="mt-3"></div>
      <button id="printBtn" class="btn btn-secondary mt-3 no-print" onclick="window.print()">Imprimir</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- tus funciones de formateo (formatCurrency, attachCurrencyFormatting, parseCurrencyValue) quedan igual ---

    document.getElementById('calculateBtn').addEventListener('click', function() {
      const clientName = document.getElementById('clientName').value;

      // 1) Calcular Boletas
      let boletasHtml = "", totalBoletas = 0;
      document.querySelectorAll('.boleta-row').forEach((row, idx) => {
        const date   = row.querySelector('.boleta-date').value;
        const amount = parseCurrencyValue(row.querySelector('.boleta-amount').value);
        totalBoletas += amount;
        boletasHtml += `<p class="print-small">Boleta ${idx+1}: ${date}, ${formatCurrency(amount)}</p>`;
      });

      // 2) Mostrar subtotal de boletas en pantalla (no-print)
      const subtotalHtml = `
        <div class="subtotal-container">
          <p class="subtotal-label">Total de Boletas vendidas por ${clientName}:</p>
          <p class="subtotal-value">${formatCurrency(totalBoletas)}</p>
        </div>
      `;
      document.getElementById('subtotalSection').innerHTML = subtotalHtml;

      // 3) Calcular ingresos por cada categoría
      let ventasHtml = "", totalVentas = 0;
      document.querySelectorAll('.venta-row').forEach((row, idx) => {
        const date   = row.querySelector('.venta-date').value;
        const amount = parseCurrencyValue(row.querySelector('.venta-amount').value);
        totalVentas += amount;
        ventasHtml += `<p class="print-small">Venta ${idx+1}: ${date}, ${formatCurrency(amount)}</p>`;
      });

      let plataHtml = "", totalPlata = 0;
      document.querySelectorAll('.plata-row').forEach((row, idx) => {
        const amount = parseCurrencyValue(row.querySelector('.plata-amount').value);
        totalPlata += amount;
        plataHtml += `<p class="print-small">Plata ${idx+1}: ${formatCurrency(amount)}</p>`;
      });

      let efectivoHtml = "", totalEfectivo = 0;
      document.querySelectorAll('.efectivo-row').forEach((row, idx) => {
        const amount = parseCurrencyValue(row.querySelector('.efectivo-amount').value);
        totalEfectivo += amount;
        efectivoHtml += `<p class="print-small">Efectivo ${idx+1}: ${formatCurrency(amount)}</p>`;
      });

      let chequeHtml = "", totalCheque = 0;
      document.querySelectorAll('.cheque-row').forEach((row, idx) => {
        const id     = row.querySelector('.cheque-id').value;
        const amount = parseCurrencyValue(row.querySelector('.cheque-amount').value);
        totalCheque += amount;
        chequeHtml += `<p class="print-small">Cheque ${idx+1} (ID: ${id}): ${formatCurrency(amount)}</p>`;
      });

      let transferenciaHtml = "", totalTransferencia = 0;
      document.querySelectorAll('.transferencia-row').forEach((row, idx) => {
        const amount = parseCurrencyValue(row.querySelector('.transferencia-amount').value);
        totalTransferencia += amount;
        transferenciaHtml += `<p class="print-small">Transferencia ${idx+1}: ${formatCurrency(amount)}</p>`;
      });

      // 4) Construir el HTML de impresión: boletas, su subtotal y todos los ingresos + su subtotal
      let summaryHtml = `<h1 class="print-header">Resumen de Cuenta con ${clientName}</h1>`;

      // Lista de boletas
      summaryHtml += `<p class="print-small"><strong>Boletas vendidas por ${clientName}:</strong></p>${boletasHtml}`;
      // Subtotal de boletas en impresión
      summaryHtml += `
        <div class="print-subtotal">
          <p><strong>Total de Boletas vendidas por ${clientName}:</strong> ${formatCurrency(totalBoletas)}</p>
        </div>
      `;

      // Detalle de ingresos
      if (totalVentas      > 0) summaryHtml += `<p class="print-small" style="margin-top:1rem;"><strong>Ventas a ${clientName}:</strong></p>${ventasHtml}`;
      if (totalPlata       > 0) summaryHtml += `<p class="print-small" style="margin-top:1rem;"><strong>Plata a Favor:</strong></p>${plataHtml}`;
      if (totalEfectivo    > 0) summaryHtml += `<p class="print-small" style="margin-top:1rem;"><strong>Efectivo:</strong></p>${efectivoHtml}`;
      if (totalCheque      > 0) summaryHtml += `<p class="print-small" style="margin-top:1rem;"><strong>Cheque:</strong></p>${chequeHtml}`;
      if (totalTransferencia>0) summaryHtml += `<p class="print-small" style="margin-top:1rem;"><strong>Transferencia:</strong></p>${transferenciaHtml}`;

      // ** NUEVA LÍNEA: Subtotal de todos los ingresos (usuario) en impresión **
      const totalIngresos = totalVentas + totalPlata + totalEfectivo + totalCheque + totalTransferencia;
      summaryHtml += `
        <div class="print-subtotal">
          <p><strong>Total de Ingresos del Usuario:</strong> ${formatCurrency(totalIngresos)}</p>
        </div>
      `;

      document.getElementById('summaryContent').innerHTML = summaryHtml;

      // 5) Calcular y mostrar Saldo Final
      const finalBalance = totalIngresos - totalBoletas;
      let finalHtml = "";
      if      (finalBalance > 0) finalHtml = `<h3 class="print-message">Saldo Final: ${formatCurrency(finalBalance)}</h3><p class="print-message">${clientName} te debe ${formatCurrency(finalBalance)}.</p>`;
      else if (finalBalance < 0) finalHtml = `<h3 class="print-message">Saldo Final: ${formatCurrency(Math.abs(finalBalance))}</h3><p class="print-message">Tú le debes ${formatCurrency(Math.abs(finalBalance))} a ${clientName}.</p>`;
      else                       finalHtml = `<h3 class="print-message">Saldo Final: ${formatCurrency(0)}</h3><p class="print-message">Las cuentas están saldadas. No hay deudas pendientes.</p>`;

      document.getElementById('finalBalanceSection').innerHTML = finalHtml;
      document.getElementById('summarySection').style.display = 'block';
    });
  </script>
</body>
</html>
